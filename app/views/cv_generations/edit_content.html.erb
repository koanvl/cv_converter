<div class="container mx-auto px-4 py-8">
  <div class="max-w-6xl mx-auto">
    <div class="flex items-center mb-6">
      <%= link_to cv_generator_path(@cv_generation.cv_candidate), class: "text-gray-600 hover:text-gray-900 mr-4" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      <% end %>
      <h1 class="text-2xl font-bold">
        Edit Resume: <%= @cv_generation.cv_candidate.name %>
      </h1>
      <span class="ml-4 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
        Template: <%= @cv_generation.example.title %>
      </span>
    </div>

    <div data-controller="editor">
      <%= form_with model: @cv_generation, url: cv_generation_path(@cv_generation), method: :patch, class: "space-y-6", data: { "editor-target": "form" } do |form| %>
        <% if @cv_generation.errors.any? %>
          <div class="bg-red-50 p-4 rounded-md">
            <h2 class="text-red-800 text-sm font-medium">
              <%= pluralize(@cv_generation.errors.count, "error") %> prohibited this resume from being saved:
            </h2>
            <ul class="mt-3 list-disc list-inside text-red-600">
              <% @cv_generation.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="mt-6">
          <%# Editor Toolbar %>
          <div class="flex flex-wrap items-center gap-1 p-2 bg-white border rounded-t mb-1">
            <div class="relative" data-controller="dropdown">
              <button type="button" 
                      data-action="dropdown#toggle"
                      class="flex items-center px-3 py-1.5 text-gray-700 rounded hover:bg-gray-100 transition-colors">
                <span class="text-sm font-medium">Text</span>
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <div data-dropdown-target="menu" 
                   class="absolute left-0 mt-1 w-40 bg-white border rounded-md shadow-lg hidden z-50">
                <button type="button" data-action="editor#toggleHeading" data-level="1" 
                        class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100">Heading 1</button>
                <button type="button" data-action="editor#toggleHeading" data-level="2"
                        class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100">Heading 2</button>
                <button type="button" data-action="editor#toggleHeading" data-level="3"
                        class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100">Heading 3</button>
              </div>
            </div>

            <div class="h-6 w-px bg-gray-200 mx-1"></div>

            <button type="button" data-action="editor#toggleBold" 
                    class="p-1.5 rounded hover:bg-gray-100 transition-colors" title="Bold">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"></path>
                <path d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"></path>
              </svg>
            </button>

            <button type="button" data-action="editor#toggleItalic"
                    class="p-1.5 rounded hover:bg-gray-100 transition-colors" title="Italic">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="19" y1="4" x2="10" y2="4"></line>
                <line x1="14" y1="20" x2="5" y2="20"></line>
                <line x1="15" y1="4" x2="9" y2="20"></line>
              </svg>
            </button>

            <div class="h-6 w-px bg-gray-200 mx-1"></div>

            <button type="button" data-action="editor#insertTwoColumnTable" 
                    class="p-1.5 rounded hover:bg-gray-100 transition-colors" title="Insert Table">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>

            <div class="h-6 w-px bg-gray-200 mx-1"></div>

            <%# Variable picker %>
            <button type="button" data-action="editor#showVariablePicker"
                    class="p-1.5 rounded hover:bg-gray-100 transition-colors" title="Insert Variable">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7h-4V3"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6"></path>
              </svg>
            </button>
          </div>

          <%# Editor Content %>
          <div data-editor-target="element" class="prose max-w-none border rounded-b min-h-[297mm] ps-[20mm] py-[10mm] pe-[10mm] bg-white"></div>
          <%= form.text_area :generated_html, data: { "editor-target": "input" }, class: "hidden", value: @cv_generation.generated_html %>
          <input type="file" accept="image/*" data-editor-target="fileInput" style="display:none" data-action="change->editor#handleFileUpload">
        </div>

        <div>
          <%= form.label :generated_css, "Custom CSS", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :generated_css, rows: 5, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm" %>
        </div>

        <div class="flex justify-end gap-4">
          <%= link_to "Cancel", cv_generator_path(@cv_generation.cv_candidate), class: "px-4 py-2 border rounded-md hover:bg-gray-50" %>
          <button type="button" data-action="editor#save" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Save Changes</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%# Modal window for variable selection %>
<div data-controller="variable-picker" 
     data-variable-picker-target="modal"
     data-action="click->variable-picker#handleOutsideClick"
     class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Select Variable</h3>
        <button type="button" 
                data-action="variable-picker#hideModal"
                class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Search -->
      <div class="mb-4">
        <input type="text" 
               data-variable-picker-target="searchInput"
               data-action="input->variable-picker#search"
               placeholder="Search variables..."
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      
      <!-- Variables List -->
      <div class="max-h-96 overflow-y-auto" data-variable-picker-target="variableList">
        <!-- Variables will be loaded via JavaScript -->
      </div>
      
      <!-- Footer -->
      <div class="mt-6 flex justify-end">
        <button type="button" 
                data-action="variable-picker#hideModal"
                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<%# Editor styles %>
<style>
.ProseMirror {
  padding: 1rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  min-height: 200px;
}
.ProseMirror:focus {
  outline: 2px solid #3b82f6;
}

/* Styles for variables in editor */
.cv-variable {
  background-color: #e3f2fd !important;
  padding: 2px 6px !important;
  border-radius: 4px !important;
  border: 1px solid #2196f3 !important;
  color: #1976d2 !important;
}

/* Styles for tables */
.ProseMirror table {
  width: 100%;
  margin: 1rem 0;
  border-collapse: collapse;
  table-layout: fixed;
}

.ProseMirror table.custom-grid-table td,
.ProseMirror table.custom-grid-table th {
  border: 1px solid #ccc;
  padding: 0.5rem;
  vertical-align: top;
  position: relative;
}

.ProseMirror table td,
.ProseMirror table th {
  padding: 0.5rem;
  vertical-align: top;
  position: relative;
}

.ProseMirror th {
  font-weight: bold;
  text-align: left;
  background-color: #f1f3f5;
}
</style>
